#!/bin/bash

echo '{"version":1}'
echo '['

first_line=true
i3status | while read -r line; do
	[[ "$line" =~ ^,??\[.*\]$ ]] || continue

	props=$(gdbus call --session --dest "org.mpris.MediaPlayer2.spotify" \
		--object-path /org/mpris/MediaPlayer2 \
		--method org.freedesktop.DBus.Properties.GetAll \
		org.mpris.MediaPlayer2.Player 2>/dev/null)

	if [[ -n "$props" && "$props" =~ \'PlaybackStatus\':[[:space:]]*\<\'([^\']+)\'\> ]]; then
		status="${BASH_REMATCH[1]}"
		if [[ "$status" == "Playing" || "$status" == "Paused" ]]; then
			[[ "$props" =~ \'xesam:title\':[[:space:]]*\<\'([^\']+)\'\> ]] && title="${BASH_REMATCH[1]}"
			[[ "$props" =~ \'xesam:artist\':[[:space:]]*\<\[\'([^\']+)\'\]\> ]] && artist="${BASH_REMATCH[1]}"

			if [[ "$status" == "Playing" ]]; then
				spotify_status=$(printf " ‚ñ∂ %s - %s " "$artist" "$title")
			else
				spotify_status=$(printf " ‚ùö‚ùö %s - %s " "$artist" "$title")
			fi
		fi
	fi

	line="${line#,}"
	line="${line#\[}"
	line="${line%\]}"

	prefix=$($first_line && echo "" || echo ",")
	$first_line && first_line=false

	capture_status="üé§ $(amixer get Capture | awk -F'[][]' '/\[/ {print $2; exit}')"

	echo "${prefix}[{\"full_text\":\"${spotify_status}\",\"color\":\"#dd77ff\"},{\"full_text\":\"${capture_status}\",\"color\":\"#ff9e64\"},${line}]"
done
